<!DOCTYPE html>
<html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<head>
<title>Code Comment</title>
</head>
<body id="body">

<style type="text/css">
.divcode {
	margin: 2px;
	overflow: hidden;
}
.code {
	float: left;
	width: 47%;
	border: 1px black solid;
	font-family: monospace;
	white-space: pre-wrap;
	tab-size: 4;
	-moz-tab-size: 4;
}
.arrow {
	float: left;
	width: 6%;
	margin: 1px;
}
.comments {
	width: 46%;
	float: left;
}
.comment {
	width: 100%;
	margin: 1px;
	border: 1px black solid;
}
</style>

<svg width="0" height="0" style="float:left">
<defs>
<marker id="arrow" markerWidth="20" markerHeight="20" refX="15" refY="10" orient="auto">
  <path d="M5,5 L15,10 L5,15 Z" stroke="black" fill="black"></path>
</marker>
</defs>
</svg>

<script type="text/javascript">
var body = document.getElementById("body"),
		div,
			code,
				sl,
				linediv,
			svg,
			comments,
				comment,
					comdiv;
var arrows = []

body.onresize = function() {
	for (var i = 0; i < arrows.length; ++i) {
		arrows[i].layout();
	}
};

var backs = [ "#f0f0f0", "#e0e0ff" ];
var lines = readFile("test.md").split('\n');
var iscode, backno = 0;

function addArrow() {
	if (!sl || !comment) return;
	var h = max(code.clientHeight, comments.clientHeight);
	svg.setAttribute("height", h + "px");
	var arr = document.createElementNS("http://www.w3.org/2000/svg", "path");
	arr.setAttribute("stroke", "black");
	arr.setAttribute("marker-end", "url(#arrow)");
	arr.layout = function(code, sl, linediv, comments, comment) {
		return function() {
			var x1 = comments.offsetLeft - (code.offsetLeft + code.offsetWidth) - 3;
			var y1 = (comment.offsetTop + comment.offsetHeight / 2) | 0;
			var y2 = ((sl.offsetTop + (linediv.offsetTop + linediv.offsetHeight)) / 2) | 0;
			y1 -= code.offsetTop;
			y2 -= code.offsetTop;
			arr.setAttribute("d", "M" + x1 + "," + y1 + " L0," + y2);
		};
	}(code, sl, linediv, comments, comment);
	arr.layout();
	svg.appendChild(arr);
	arrows.push(arr);
}

for (var i = 0; i <= lines.length; ++i) {
	if (i == lines.length || lines[i] == "") {
		if (comment && sl) addArrow();
		div = undefined;
		continue;
	}
	if (!div) {
		div = document.createElement("div");
		div.className = "divcode";
		body.appendChild(div);

		code = document.createElement("div");
		code.className = "code";
		div.appendChild(code);

		svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
		svg.setAttribute("class", "arrow");
		div.appendChild(svg);

		comments = document.createElement("div");
		comments.className = "comments";
		div.appendChild(comments);

		iscode = true;
		backno = 0;
		linediv = sl = null;
	}
	var line = escape(lines[i]);
	if (line == "----") {
		if (iscode) {
			comment = null;
		} else {
			if (comment && sl) addArrow();
			backno = 1 - backno;
			linediv = sl = comment = null;
		}
		iscode = !iscode;
	} else if (!iscode && line.substring(0, 2) == "//") {
		// skip
	} else {
		if (iscode) {
			linediv = document.createElement("div");
			linediv.innerHTML = line;
			linediv.style.backgroundColor = backs[backno];
			code.appendChild(linediv);
			if (!sl) sl = linediv;
		} else {
			if (!comment) {
				comment = document.createElement("div");
				comment.className = "comment";
				comments.appendChild(comment);
			}
			comdiv = document.createElement("div");
			comdiv.innerHTML = line;
			comment.appendChild(comdiv);
		}
	}
}

function escape(line) {
	return line
		.replace("&", "&amp;")
		.replace("<", "&lt;")
		.replace(">", "&gt;");
}

function max(a, b) {
	return a > b ? a : b;
}

function readFile(name)
{
	var xhr = window.ActiveXObject ?
		new ActiveXObject("Msxml2.XMLHTTP") : new XMLHttpRequest();
	xhr.open("GET", name, false);
	xhr.send("");
	return xhr.responseText;
}
</script>
</body>
</html>
